import{aq as R,h as w,ar as b,f as P,a3 as q,aF as V,q as _,aG as H,aH as r,ap as s,aA as S}from"./CXBtRYQN.js";import{j as C,M as D}from"./B-bm3bX7.js";function Y(e,t,n,o){var c=e.__attributes??(e.__attributes={});_&&(c[t]=e.getAttribute(t),t==="src"||t==="srcset"||t==="href"&&e.nodeName==="LINK")||c[t]!==(c[t]=n)&&(t==="style"&&"__styles"in e&&(e.__styles={}),t==="loading"&&(e[V]=n),n==null?e.removeAttribute(t):typeof n!="string"&&U(e).includes(t)?e[t]=n:e.setAttribute(t,n))}function Me(e,t,n){var o=b,c=P;R(null),w(null);try{(J.has(e.nodeName)||!customElements||customElements.get(e.tagName.toLowerCase())?U(e).includes(t):n&&typeof n=="object")?e[t]=n:Y(e,t,n==null?n:String(n))}finally{R(o),w(c)}}var J=new Map;function U(e){var t=J.get(e.nodeName);if(t)return t;J.set(e.nodeName,t=[]);for(var n,o=e,c=Element.prototype;c!==o;){n=H(o);for(var a in n)n[a].set&&t.push(a);o=q(o)}return t}function Z(e,t){const n="vpaas-magic-cookie-6f95a834327944d5a89131bd1fdafd00/e498d6",o="vpaas-magic-cookie-6f95a834327944d5a89131bd1fdafd00",c={alg:"RS256",typ:"JWT",kid:n},a=C.KJUR.jws.IntDate.getNow(),f=C.KJUR.jws.IntDate.get("now + 1hour"),u={aud:"jitsi",nbf:a,exp:f,iss:"chat",context:{user:{name:e}},sub:o,room:t},y=JSON.stringify(c),F=JSON.stringify(u);return C.KJUR.jws.JWS.sign("RS256",y,F,"-----BEGIN RSA PRIVATE KEY-----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-----END RSA PRIVATE KEY-----")}const I=r([]),X={emergencies:I};function $(e,t){var f,u;console.log("User joined",e,t);const n=[...s(I)],o=((u=(f=t.getIdentity())==null?void 0:f.user)==null?void 0:u.avatar)??{};if(!o||o=="")return;const c=JSON.parse(o),a=n.findIndex(y=>y.name==c.name);a>=0&&n.splice(a,1),n.push(c),I.set(n)}function ee(e){const t=[...s(I)],n=t.findIndex(o=>o.name==e.name);n>=0&&t.splice(n,1),t.push(e),I.set(t)}const te={...X,registerWaitingRoom:()=>{const e=A();m().on(e.events.conference.USER_JOINED,$)},upsertEmergency:ee},T=()=>te;let E,i,M,g;const Q=[],m=()=>g;let x=!1;const A=()=>E;function ne(){x||(x=!0,E=i=window.JitsiMeetJS,i.init({}),i.setLogLevel(i.logLevels.INFO),console.log(`using LJM version ${i.version}!`))}async function oe(e){console.log("ESTABLISHED!");const t=v();let n=s(t.currentRoom);const o=s(t.isAgent);(!n||n=="")&&(n="waitingrm"),console.log("ESTABLISHED",e,n,o,s(t.jwt));const c=M.initJitsiConference(n,{});if(g=c,c.on(i.events.conference.CONFERENCE_JOINED,ie),c.on(i.events.conference.PRIVATE_MESSAGE_RECEIVED,ce),c.on(i.events.conference.ENDPOINT_MESSAGE_RECEIVED,ae),c.on(i.events.conference.KICKED,fe),c.on(i.events.conference.USER_LEFT,le),c.on(i.events.conference.TRACK_ADDED,ge),t.registerConn(),n!="waitingrm")try{const a=await i.createLocalTracks({devices:["audio","video"]});for(let f=0;f<a.length;f++){const u=a[f];typeof u=="object"&&(c.addTrack(u),Q.push(u))}}catch(a){console.error(a)}c.join("",!0)}function se(e){console.log("FAILED",e)}function ce(e,t){console.log("MSG:",e,t)}function ae(e){console.log("MSG:",e)}function re(e){console.log("DISCONNECT",e)}function ie(){const e=s(v().currentRoom);console.log("ConferenceJoined",e)}function le(e,t){console.log("***user left",e,t)}function ge(e){e.isLocal()||v().remoteTracks.update(n=>(n.push(e),n))}function fe(){const e=v();if(s(e.currentRoom)!="waitingrm")return;const n=s(e.targetRoom);e.startNewCall(n)}async function ue(e){ne();const t=v(),n=s(t.jwt);e??(e=s(t.currentRoom));const o="vpaas-magic-cookie-6f95a834327944d5a89131bd1fdafd00";t.currentRoom.set(e),e=="waitingrm"&&T().emergencies.set([]);const c={hosts:{domain:"8x8.vc",muc:`conference.${o}.8x8.vc`,focus:"focus.8x8.vc"},serviceUrl:`wss://8x8.vc/${o}/xmpp-websocket?room=${e}`,websocketKeepAliveUrl:`https://8x8.vc/${o}/_unlock?room=${e}`,p2p:{enabled:!0},callStatsID:"706724306",callStatsSecret:"f+TKWryzPOyX:dNR8PMw42WJwM3YM1XkJUjPOLY0M40wz+0D4mZud8mQ=",confID:`https://8x8.vc/${o}/${e}`,siteID:o,applicationName:"Voxx Emergency Services",logging:{defaultLogLevel:"trace","modules/RTC/TraceablePeerConnection.js":"info","modules/statistics/CallStats.js":"info","modules/xmpp/strophe.util.js":"log"}},a=new E.JitsiConnection(void 0,n,c);a.addEventListener(E.events.connection.CONNECTION_ESTABLISHED,oe),a.addEventListener(E.events.connection.CONNECTION_FAILED,se),a.addEventListener(E.events.connection.CONNECTION_DISCONNECTED,re),M=a,a.connect({})}async function de(){try{g.sendMessage(":hangup?:")}catch{}k()}async function k(){for(const t of Q)try{t.stopStream(),await t.dispose()}catch{}try{for(const t of g.getLocalTracks(D.AUDIO))try{t.stopStream(),g.removeTrack(t),await t.dispose()}catch{}for(const t of g.getLocalTracks(D.VIDEO))try{t.stopStream(),await t.dispose(),g.removeTrack(t)}catch{}}catch{}try{await g.hangup()}catch{}try{await g.leave()}catch{}const e=v();e.meetingActive.set(!1),e.currentRoom.set(""),e.saveMeetingState(),s(e.isAgent)?S("agent"):S("/")}const O={create:ue,hangup:de,cleanup:k},me=()=>window.VOXX_AGENT_BUILD,B=r(""),pe=r(""),K=r([]),j=r([]),Ee=r(!1),Se=r(!1),ve=r(""),Ae=r(""),z=r(""),p=r(""),Ie=r(""),h=r(""),N=r(!1),l=r(!1),Ne=r([]);let L=!1;const he={selection:B,selectionLabel:pe,messages:K,responses:j,loading:Ee,canType:Se,userInput:ve,recommendations:Ae,jwt:h,username:z,currentRoom:p,meetingActive:N,isAgent:l,targetRoom:Ie,remoteTracks:Ne};function ye(){if(L)return;L=!0;const e=localStorage.getItem("meetCtx")??"";let t;try{t=JSON.parse(e)}catch(o){t={identity:"",meetingActive:!1,room:"",isAgent:s(l)},localStorage.setItem("meetCtx","{}"),console.log("Resumption err",o)}h.set(t.identity),N.set(t.meetingActive),p.set(t.room);const n=me();if(s(l)||l.set(n??!1),s(N)==!0){if(s(l)&&s(p)=="waitingrm")return;S("/call")}}function G(){const e={meetingActive:s(N),identity:s(h),room:s(p),isAgent:s(l)};try{const t=JSON.stringify(e);localStorage.setItem("meetCtx",t)}catch(t){localStorage.setItem("meetCtx","{}"),console.log("Save err",t)}}function W(e="waitingrm"){return p.set(e),h.set(Z(s(z),e)),N.set(!0),G(),console.log("creating new call",e),O.create(e)}async function Ce(e){const t=m(),n=(Math.random()+1).toString(36).substring(2);try{t.sendMessage(`:exit_connect?:${n}`,e.connectionId),t.leave()}catch(o){console.error(o)}console.log("Starting new call",n),d.currentRoom.set(n),S("/call")}function Je(){return s(l)||(B.set(""),K.set([]),j.set([])),O.hangup()}function Te(e,t){console.log("New ROOM message",t,"from",e);const n=s(l);t.startsWith(":hangup?:")&&s(d.currentRoom)!="waitingrm"&&m().leave().then(()=>{O.hangup().then(()=>{n?S("/agent"):S("/")})})}function Oe(e,t){console.log("New message",t,"from",e);const n=s(l);if(!n&&t.startsWith(":exit_connect?:")){const o=t.substring(15);m().leave().then(()=>W(o));return}if(n&&t.startsWith(":ctx:")){const o=t.substring(5),c=JSON.parse(o);T().upsertEmergency(c)}}function Re(e,t){if(console.log("Some random user joined",t.getRole()),!s(l)){if(s(p)=="waitingrm"){const n={connectionId:m().myUserId(),name:s(d.username),issue:s(d.selection),input:s(d.userInput),recommendations:s(d.recommendations)},o=`:ctx:${JSON.stringify(n)}`;m().sendMessage(o,e)}}}function we(e){s(l)&&s(p)=="waitingrm"&&T().emergencies.update(n=>{const o=n.findIndex(c=>c.connectionId==e);return o>=0&&n.splice(o,1),n})}const d={...he,resume:ye,saveMeetingState:G,startNewCall:W,endCall:Je,agentConnect:Ce,registerConn:()=>{const e=m();e.on(A().events.conference.PRIVATE_MESSAGE_RECEIVED,Oe),e.on(A().events.conference.MESSAGE_RECEIVED,Te),e.on(A().events.conference.USER_JOINED,Re),e.on(A().events.conference.USER_LEFT,we)}},v=()=>d;export{me as I,T as a,Me as s,v as u};
